{% extends '_layouts/base_portal.html' %}
{% load staticfiles %}

{% block title %}Spend by Product & Category{% endblock title %}

{% block css %}
{% endblock css %}

{% block header %}<h1>Spend by Product & Category</h1>{% endblock header %}

{% block content %}
<section class="content"> 

  {% if not items %}
    <!-- If no items have been delivered/received i.e no 'spend' -->
      {% include "_includes/docs/no_docs_add_now.html" with text="You haven't recorded any spend yet!" href='receive_pos' action='Receive items now' %}
      
  {% else %}
    <div class="row">
      {% include "_includes/analysis_chart.html" with chartID='categoryChart' legendID='categoryLegend' title='Spend by Category' %}
      {% include "_includes/analysis_chart.html" with chartID='productChart' legendID='productLegend' title='Spend by Product' %}
    </div> 
        
  {% endif %}

{% endblock content %}


{% block js %}
  <script src="{% static 'plugins/chartjs/Chart.min.js' %}"></script>  
  <script type="text/javascript">

    var pastelColors = function(){
        var r = (Math.round(Math.random()* 127) + 127).toString(16);
        var g = (Math.round(Math.random()* 127) + 127).toString(16);
        var b = (Math.round(Math.random()* 127) + 127).toString(16);
        return '#' + r + g + b;
    }

    var options = {
        tooltipTemplate: "<%= label %> ($<%= value %>)",
        animation : false,
        legendTemplate : '<ul class="pie-legend">'
                  +'<% for (var i=0; i<segments.length; i++) { %>'
                    +'<li>'
                    +'<span style=\"background-color:<%=segments[i].fillColor%>\"></span>'
                    +'<% if (segments[i].label) { %><%= segments[i].label %> <% } %>'
                  +'</li>'
                +'<% } %>'
              +'</ul>'
      };

    $(function () {  

      /****************** 
      Spend by Category      
      ********************/
      var categoryData = [];
      {% for item in category_spend %}
        categoryData[{{forloop.counter0}}] = {
          value: {{item.total_spend}},
          label: '{{item.product__category__name}}',
          color: pastelColors(),
        };
      {% endfor %}
      var categoryCtx = $("#categoryChart").get(0).getContext("2d");      
      var categoryChart = new Chart(categoryCtx).Pie(categoryData, options);
      $('#categoryLegend').append(categoryChart.generateLegend());

      /****************** 
      Spend by Product      
      ********************/     
      var productData = [];
      {% for item in product_spend %}
        productData[{{forloop.counter0}}] = {
          value: {{item.total_spend}},
          label: '{{item.product__name}}',
          color: pastelColors(),
        };
      {% endfor %}
      var productCtx = $("#productChart").get(0).getContext("2d");
      var productChart = new Chart(productCtx).Pie(productData, options);
      $('#productLegend').append(productChart.generateLegend());

     
    });


  </script>
{% endblock js %}
